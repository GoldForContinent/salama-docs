<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salama Docs - Debug Tools</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-button {
            background: #006600;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .debug-button:hover {
            background: #004400;
        }
        .debug-button.danger {
            background: #BB0000;
        }
        .debug-button.danger:hover {
            background: #880000;
        }
        .debug-button.warning {
            background: #ffc107;
            color: black;
        }
        .debug-button.warning:hover {
            background: #e0a800;
        }
        .console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #00ff00; }
        .status-error { background: #ff0000; }
        .status-warning { background: #ffff00; }
        .status-info { background: #0000ff; }
    </style>
</head>
<body>
    <h1>üîß Salama Docs Debug Tools</h1>
    
    <div class="debug-section">
        <h2>üìä Database Status</h2>
        <p>Check the current state of your database and reports.</p>
        <button class="debug-button" onclick="window.debugDatabase()">Check Database State</button>
        <button class="debug-button" onclick="window.debugFoundReports()">Check Found Reports</button>
        <button class="debug-button" onclick="window.debugDatabaseTables()">Test Database Tables</button>
        <button class="debug-button" onclick="window.debugSpecificReports()">Debug Current Reports</button>
        <button class="debug-button" onclick="window.comprehensiveDatabaseCheck()">Comprehensive Database Check</button>
        <div class="console-output" id="database-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>üß™ Test Functions</h2>
        <p>Test the creation of found reports and matching functionality.</p>
        <button class="debug-button warning" onclick="window.testCreateFoundReport()">Create Test Found Report</button>
        <button class="debug-button warning" onclick="window.testCreateMatchingFoundReport()">Create Matching Found Report</button>
        <button class="debug-button warning" onclick="window.createMatchingFoundReportForCurrentUser()">Create Found Report for Current User</button>
        <button class="debug-button" onclick="window.triggerMatching()">Run Manual Matching</button>
        <button class="debug-button" onclick="window.forceCreateMatch()">Force Create Match</button>
        <button class="debug-button" onclick="window.testRecoveredReport()">Create Test Recovered Report</button>
        <div class="console-output" id="test-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>üîç Matching Debug</h2>
        <p>Debug the automated matching process.</p>
        <button class="debug-button" onclick="window.runAutomatedMatching()">Run Automated Matching</button>
        <button class="debug-button" onclick="window.debugRecoveredReports()">Check Recovered Reports</button>
        <button class="debug-button" onclick="window.testMatchingWithAllReports()">Test Matching with ALL Reports</button>
        <button class="debug-button" onclick="window.checkRLSPolicies()">Check RLS Policies</button>
        <div class="console-output" id="matching-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>üìã Quick Actions</h2>
        <p>Quick actions to help with testing.</p>
        <button class="debug-button" onclick="clearConsole()">Clear Console Output</button>
        <button class="debug-button danger" onclick="clearAllData()">Clear All Test Data</button>
        <button class="debug-button danger" onclick="window.clearAllTablesData()">Clear ALL Tables Data</button>
        <button class="debug-button danger" onclick="window.removeTestFoundReports()">Remove Test Found Reports</button>
        <button class="debug-button danger" onclick="window.removeSpecificTestReport('7f1c77b3-896a-4323-ac08-a62fb0767c82')">Remove Specific Test Report</button>
        <button class="debug-button" onclick="goToFoundReport()">Go to Found Report Page</button>
        <button class="debug-button" onclick="goToDashboard()">Go to Dashboard</button>
    </div>
    
    <div class="debug-section">
        <h2>üìù Instructions</h2>
        <ol>
            <li><strong>First:</strong> Click "Check Database State" to see current reports</li>
            <li><strong>If no found reports:</strong> Click "Create Test Found Report" to create one</li>
            <li><strong>Test matching:</strong> Click "Run Manual Matching" to test the matching algorithm</li>
            <li><strong>Check results:</strong> Use "Check Found Reports" to verify the test report was created</li>
            <li><strong>If issues persist:</strong> Use "Test Database Tables" to check permissions</li>
        </ol>
        
        <h3>üîç What to Look For:</h3>
        <ul>
            <li><span class="status-indicator status-success"></span> <strong>Success:</strong> Found reports count > 0</li>
            <li><span class="status-indicator status-error"></span> <strong>Error:</strong> Database permission errors</li>
            <li><span class="status-indicator status-warning"></span> <strong>Warning:</strong> Reports created but not matching</li>
            <li><span class="status-indicator status-info"></span> <strong>Info:</strong> Check document numbers match exactly</li>
        </ul>
    </div>

    <script type="module">
        import { supabase } from './js/supabase.js';
        
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(message, type = 'log') {
            const output = document.getElementById('database-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#00ff00';
            
            output.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        // Global functions
        window.clearConsole = function() {
            document.getElementById('database-output').innerHTML = '';
            document.getElementById('test-output').innerHTML = '';
            document.getElementById('matching-output').innerHTML = '';
        };
        
        window.clearAllData = async function() {
            if (!confirm('Are you sure you want to delete all test data? This cannot be undone.')) {
                return;
            }
            
            try {
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('Please log in first');
                    return;
                }
                
                console.log('üóëÔ∏è === CLEARING ALL DATA FOR FRESH START ===');
                
                // Delete all reports for current user
                const { error } = await supabase
                    .from('reports')
                    .delete()
                    .eq('user_id', user.id);
                    
                if (error) {
                    console.error('Error clearing data:', error);
                    alert('Error clearing data: ' + error.message);
                } else {
                    console.log('‚úÖ All test data cleared successfully');
                    alert('All test data cleared successfully');
                }
            } catch (error) {
                console.error('Error in clearAllData:', error);
                alert('Error clearing data: ' + error.message);
            }
        };

        // Comprehensive function to delete ALL data from all tables
        window.clearAllTablesData = async function() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data from ALL report tables for ALL users. This cannot be undone. Are you absolutely sure?')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è === COMPREHENSIVE DATA CLEARING ===');
                
                // Delete from all tables in the correct order (respecting foreign keys)
                const tables = [
                    'recovered_reports',
                    'finder_info', 
                    'report_documents',
                    'reports'
                ];
                
                for (const table of tables) {
                    console.log(`üóëÔ∏è Clearing table: ${table}`);
                    
                    const { error } = await supabase
                        .from(table)
                        .delete()
                        .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all rows
                        
                    if (error) {
                        console.error(`‚ùå Error clearing ${table}:`, error);
                    } else {
                        console.log(`‚úÖ Successfully cleared ${table}`);
                    }
                }
                
                console.log('‚úÖ All tables cleared successfully!');
                alert('All data cleared successfully! Database is now fresh and ready for testing.');
                
                // Refresh the database state
                setTimeout(async () => {
                    console.log('üîÑ Refreshing database state...');
                    if (typeof window.debugDatabase === 'function') {
                        await window.debugDatabase();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error in clearAllTablesData:', error);
                alert('Error clearing all data: ' + error.message);
            }
        };

        // Function to debug specific reports and their documents
        window.debugSpecificReports = async function() {
            console.log('üîç === DEBUGGING SPECIFIC REPORTS ===');
            
            try {
                // Get the specific reports we can see in the table
                const reportIds = [
                    '28416ade-f01a-4de4-82ac-bc963865a96e', // Lost report
                    'e9cfd1db-660a-4a74-ab12-0933f36ab5ba'  // Found report
                ];
                
                for (const reportId of reportIds) {
                    console.log(`\nüìã Analyzing Report: ${reportId}`);
                    
                    // Get the report details
                    const { data: report, error: reportError } = await supabase
                        .from('reports')
                        .select('*')
                        .eq('id', reportId)
                        .single();
                        
                    if (reportError) {
                        console.error(`‚ùå Error fetching report ${reportId}:`, reportError);
                        continue;
                    }
                    
                    console.log(`üìÑ Report Details:`);
                    console.log(`   Type: ${report.report_type}`);
                    console.log(`   Status: ${report.status}`);
                    console.log(`   Full Name: ${report.full_name}`);
                    console.log(`   Phone: ${report.phone}`);
                    console.log(`   User ID: ${report.user_id}`);
                    
                    // Get the documents for this report
                    const { data: documents, error: docsError } = await supabase
                        .from('report_documents')
                        .select('*')
                        .eq('report_id', reportId);
                        
                    if (docsError) {
                        console.error(`‚ùå Error fetching documents for ${reportId}:`, docsError);
                    } else {
                        console.log(`üìÑ Documents (${documents.length}):`);
                        documents.forEach((doc, index) => {
                            console.log(`   Document ${index + 1}:`);
                            console.log(`     Type: ${doc.document_type}`);
                            console.log(`     Number: "${doc.document_number}"`);
                            console.log(`     Category: ${doc.category}`);
                            console.log(`     Is Recovered: ${doc.is_recovered}`);
                        });
                    }
                }
                
                // Now let's try to match them manually
                console.log('\nüîç === MANUAL MATCHING ATTEMPT ===');
                
                const { data: allReports, error: allError } = await supabase
                    .from('reports')
                    .select('*, report_documents(*)');
                    
                if (allError) {
                    console.error('‚ùå Error fetching all reports:', allError);
                    return;
                }
                
                const lostReports = allReports.filter(r => r.report_type === 'lost');
                const foundReports = allReports.filter(r => r.report_type === 'found');
                
                console.log(`üìä Found ${lostReports.length} lost reports and ${foundReports.length} found reports`);
                
                // Compare each lost report with each found report
                for (const lostReport of lostReports) {
                    for (const foundReport of foundReports) {
                        console.log(`\nüîç Comparing:`);
                        console.log(`   Lost: ${lostReport.full_name} (${lostReport.id})`);
                        console.log(`   Found: ${foundReport.full_name} (${foundReport.id})`);
                        
                        if (lostReport.report_documents && foundReport.report_documents) {
                            for (const lostDoc of lostReport.report_documents) {
                                for (const foundDoc of foundReport.report_documents) {
                                    console.log(`   üìÑ Lost doc: ${lostDoc.document_type} ("${lostDoc.document_number}")`);
                                    console.log(`   üìÑ Found doc: ${foundDoc.document_type} ("${foundDoc.document_number}")`);
                                    
                                    if (lostDoc.document_type === foundDoc.document_type) {
                                        console.log(`   ‚úÖ Document types match: ${lostDoc.document_type}`);
                                        
                                        if (lostDoc.document_number === foundDoc.document_number) {
                                            console.log(`   üéØ MATCH FOUND! Document numbers match: "${lostDoc.document_number}"`);
                                            
                                            // Check if this match already exists in recovered_reports
                                            const { data: existingMatch } = await supabase
                                                .from('recovered_reports')
                                                .select('*')
                                                .or(`lost_report_id.eq.${lostReport.id},found_report_id.eq.${foundReport.id}`)
                                                .maybeSingle();
                                            
                                            if (existingMatch) {
                                                console.log(`   ‚ö†Ô∏è Match already exists in recovered_reports:`, existingMatch);
                                            } else {
                                                console.log(`   ‚úÖ No existing match found - should create new match`);
                                            }
                                        } else {
                                            console.log(`   ‚ùå Document numbers don't match: "${lostDoc.document_number}" vs "${foundDoc.document_number}"`);
                                        }
                                    } else {
                                        console.log(`   ‚ùå Document types don't match: ${lostDoc.document_type} vs ${foundDoc.document_type}`);
                                    }
                                }
                            }
                        }
                    }
                }
                
                console.log('üîç === END DEBUGGING SPECIFIC REPORTS ===');
                
            } catch (error) {
                console.error('‚ùå Error in debugSpecificReports:', error);
            }
        };

        // Function to force create a match for the current reports
        window.forceCreateMatch = async function() {
            console.log('üîß === FORCE CREATING MATCH ===');
            
            try {
                const lostReportId = '28416ade-f01a-4de4-82ac-bc963865a96e';
                const foundReportId = 'e9cfd1db-660a-4a74-ab12-0933f36ab5ba';
                
                console.log(`üîß Force creating match between:`);
                console.log(`   Lost Report: ${lostReportId}`);
                console.log(`   Found Report: ${foundReportId}`);
                
                // Update both reports to potential_match
                const { error: lostError } = await supabase
                    .from('reports')
                    .update({ status: 'potential_match' })
                    .eq('id', lostReportId);
                    
                const { error: foundError } = await supabase
                    .from('reports')
                    .update({ status: 'potential_match' })
                    .eq('id', foundReportId);
                
                if (lostError || foundError) {
                    console.error('‚ùå Error updating report statuses:', lostError || foundError);
                    return;
                }
                
                console.log('‚úÖ Updated both reports to potential_match status');
                
                // Insert into recovered_reports
                const { error: recoveredError } = await supabase
                    .from('recovered_reports')
                    .insert({
                        lost_report_id: lostReportId,
                        found_report_id: foundReportId,
                        status: 'recovered'
                    });
                
                if (recoveredError) {
                    console.error('‚ùå Error creating recovered report:', recoveredError);
                    return;
                }
                
                console.log('‚úÖ Successfully created recovered report entry');
                console.log('üéâ Match created successfully!');
                
                // Refresh the database state
                setTimeout(async () => {
                    console.log('üîÑ Refreshing database state...');
                    if (typeof window.debugDatabase === 'function') {
                        await window.debugDatabase();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error in forceCreateMatch:', error);
            }
        };

        // Comprehensive database check function
        window.comprehensiveDatabaseCheck = async function() {
            console.log('üîç === COMPREHENSIVE DATABASE CHECK ===');
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    console.error('‚ùå User not authenticated');
                    return;
                }
                
                console.log('üë§ Current user:', user.email);
                console.log('üÜî User ID:', user.id);
                
                // Check all reports without any filters
                console.log('\nüìä === CHECKING ALL REPORTS ===');
                const { data: allReports, error: allReportsError } = await supabase
                    .from('reports')
                    .select('*');
                    
                if (allReportsError) {
                    console.error('‚ùå Error fetching all reports:', allReportsError);
                    console.error('Error details:', JSON.stringify(allReportsError, null, 2));
                } else {
                    console.log(`üìã Total reports in database: ${allReports.length}`);
                    
                    allReports.forEach((report, index) => {
                        console.log(`\nüìÑ Report ${index + 1}:`);
                        console.log(`   ID: ${report.id}`);
                        console.log(`   Type: ${report.report_type}`);
                        console.log(`   Status: ${report.status}`);
                        console.log(`   Full Name: ${report.full_name}`);
                        console.log(`   User ID: ${report.user_id}`);
                        console.log(`   Created: ${report.created_at}`);
                    });
                }
                
                // Check reports for current user only
                console.log('\nüë§ === CHECKING CURRENT USER REPORTS ===');
                const { data: userReports, error: userReportsError } = await supabase
                    .from('reports')
                    .select('*')
                    .eq('user_id', user.id);
                    
                if (userReportsError) {
                    console.error('‚ùå Error fetching user reports:', userReportsError);
                } else {
                    console.log(`üìã Reports for current user: ${userReports.length}`);
                    
                    userReports.forEach((report, index) => {
                        console.log(`\nüìÑ User Report ${index + 1}:`);
                        console.log(`   ID: ${report.id}`);
                        console.log(`   Type: ${report.report_type}`);
                        console.log(`   Status: ${report.status}`);
                        console.log(`   Full Name: ${report.full_name}`);
                    });
                }
                
                // Check all documents
                console.log('\nüìÑ === CHECKING ALL DOCUMENTS ===');
                const { data: allDocuments, error: allDocsError } = await supabase
                    .from('report_documents')
                    .select('*');
                    
                if (allDocsError) {
                    console.error('‚ùå Error fetching all documents:', allDocsError);
                } else {
                    console.log(`üìÑ Total documents in database: ${allDocuments.length}`);
                    
                    allDocuments.forEach((doc, index) => {
                        console.log(`\nüìÑ Document ${index + 1}:`);
                        console.log(`   ID: ${doc.id}`);
                        console.log(`   Report ID: ${doc.report_id}`);
                        console.log(`   Type: ${doc.document_type}`);
                        console.log(`   Number: "${doc.document_number}"`);
                        console.log(`   Category: ${doc.category}`);
                    });
                }
                
                // Check specific report IDs we know exist
                console.log('\nüéØ === CHECKING SPECIFIC REPORT IDS ===');
                const specificIds = [
                    '28416ade-f01a-4de4-82ac-bc963865a96e',
                    'e9cfd1db-660a-4a74-ab12-0933f36ab5ba'
                ];
                
                for (const reportId of specificIds) {
                    console.log(`\nüîç Checking report ID: ${reportId}`);
                    
                    const { data: specificReport, error: specificError } = await supabase
                        .from('reports')
                        .select('*')
                        .eq('id', reportId)
                        .maybeSingle();
                        
                    if (specificError) {
                        console.error(`‚ùå Error fetching report ${reportId}:`, specificError);
                    } else if (specificReport) {
                        console.log(`‚úÖ Found report: ${specificReport.report_type} - ${specificReport.full_name}`);
                    } else {
                        console.log(`‚ùå Report ${reportId} not found`);
                    }
                }
                
                // Check RLS (Row Level Security) policies
                console.log('\nüîí === CHECKING RLS POLICIES ===');
                console.log('Note: RLS policies might be preventing access to reports from other users');
                
                console.log('üîç === END COMPREHENSIVE DATABASE CHECK ===');
                
            } catch (error) {
                console.error('‚ùå Error in comprehensiveDatabaseCheck:', error);
            }
        };

        // Function to create a found report for the current user with matching document
        window.createMatchingFoundReportForCurrentUser = async function() {
            console.log('üß™ === CREATING MATCHING FOUND REPORT FOR CURRENT USER ===');
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    console.error('‚ùå User not authenticated');
                    return;
                }
                
                console.log('üë§ Current user:', user.email);
                
                // Get the current user's lost report to find the document number
                const { data: userReports, error: userReportsError } = await supabase
                    .from('reports')
                    .select('*, report_documents(*)')
                    .eq('user_id', user.id)
                    .eq('report_type', 'lost');
                    
                if (userReportsError || !userReports || userReports.length === 0) {
                    console.error('‚ùå No lost reports found for current user');
                    return;
                }
                
                const lostReport = userReports[0];
                const lostDocument = lostReport.report_documents[0];
                
                console.log(`üìÑ Found lost report: ${lostReport.id}`);
                console.log(`üìÑ Lost document: ${lostDocument.document_type} (${lostDocument.document_number})`);
                
                // Create a found report with the same document number
                const foundReport = {
                    user_id: user.id,
                    report_type: 'found',
                    status: 'active',
                    full_name: 'Test Finder - Current User',
                    phone: '0712345678',
                    email: user.email,
                    location_description: 'Test Location - Current User',
                    collection_point: 'Test Chief\'s Office - Current User',
                    reward_amount: 100
                };
                
                console.log('üìù Creating found report:', foundReport);
                
                const { data: newReport, error: reportError } = await supabase
                    .from('reports')
                    .insert(foundReport)
                    .select()
                    .single();
                    
                if (reportError) {
                    console.error('‚ùå Error creating found report:', reportError);
                    return;
                }
                
                console.log('‚úÖ Found report created:', newReport);
                
                // Create the matching document
                const foundDocument = {
                    report_id: newReport.id,
                    document_type: lostDocument.document_type,
                    document_number: lostDocument.document_number, // EXACT SAME NUMBER
                    category: lostDocument.category,
                    is_recovered: false
                };
                
                console.log('üìÑ Creating matching document:', foundDocument);
                
                const { error: docError } = await supabase
                    .from('report_documents')
                    .insert(foundDocument);
                    
                if (docError) {
                    console.error('‚ùå Error creating document:', docError);
                } else {
                    console.log('‚úÖ Matching document created successfully');
                }
                
                // Verify the report was created
                const { data: verifyReport, error: verifyError } = await supabase
                    .from('reports')
                    .select('*, report_documents(*)')
                    .eq('id', newReport.id)
                    .single();
                    
                if (verifyError) {
                    console.error('‚ùå Error verifying report:', verifyError);
                } else {
                    console.log('‚úÖ Report verification:', verifyReport);
                }
                
                console.log('üß™ === END CREATING MATCHING FOUND REPORT ===');
                
                // Automatically run matching after creating the report
                setTimeout(async () => {
                    console.log('üîç Running matching after creating found report...');
                    if (typeof window.runAutomatedMatching === 'function') {
                        await window.runAutomatedMatching();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error in createMatchingFoundReportForCurrentUser:', error);
            }
        };
        
        window.goToFoundReport = function() {
            window.location.href = 'reportfound.html';
        };
        
        window.goToDashboard = function() {
            window.location.href = 'dashboard.html';
        };
        
        // Load required scripts
        const scripts = [
            './js/dashboard.js',
            './js/reportfound.js'
        ];
        
        scripts.forEach(src => {
            const script = document.createElement('script');
            script.src = src;
            script.type = 'module';
            document.head.appendChild(script);
        });
        
        console.log('üîß Debug tools loaded successfully');
        console.log('üìã Available functions:');
        console.log('  - window.debugDatabase()');
        console.log('  - window.debugFoundReports()');
        console.log('  - window.testCreateFoundReport()');
        console.log('  - window.triggerMatching()');
        console.log('  - window.runAutomatedMatching()');
    </script>
</body>
</html> 