<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Salama Documents</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="./css/style.css">
    
    <style>
        /* Notifications Page Specific Styles */
        .notifications-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
        }

        .notifications-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .notifications-header {
            background: linear-gradient(135deg, var(--kenya-red), #c41e3a);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .notifications-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .notifications-header p {
            margin: 10px 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .back-to-dashboard {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-to-dashboard:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .notifications-controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .notification-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            border-color: var(--kenya-red);
            background: #fff5f5;
        }

        .filter-btn.active {
            background: var(--kenya-red);
            color: white;
            border-color: var(--kenya-red);
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--kenya-red);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bulk-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mark-all-read {
            background: var(--kenya-green);
            color: white;
        }

        .mark-all-read:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .delete-selected {
            background: var(--kenya-red);
            color: white;
        }

        .delete-selected:hover {
            background: #c41e3a;
            transform: translateY(-2px);
        }

        .delete-selected:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .notifications-list {
            padding: 20px 30px;
            min-height: 400px;
        }

        .notification-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .notification-item:hover {
            border-color: var(--kenya-red);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .notification-item.unread {
            border-left: 5px solid var(--kenya-red);
            background: #fff5f5;
        }

        .notification-checkbox {
            margin-top: 5px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .notification-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .notification-icon.success {
            background: #e8f5e8;
            color: #4caf50;
        }

        .notification-icon.warning {
            background: #fff3e0;
            color: #ff9800;
        }

        .notification-icon.error {
            background: #ffebee;
            color: #f44336;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-message {
            font-size: 1rem;
            line-height: 1.5;
            color: #333;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .notification-time {
            font-weight: 500;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
        }

        .notification-actions button {
            padding: 4px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .notification-actions button:hover {
            border-color: var(--kenya-red);
            background: #fff5f5;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            color: #495057;
        }

        .empty-state p {
            margin: 0;
            font-size: 1rem;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .loading-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-count-badge {
            background: var(--kenya-red);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .notifications-header h1 {
                font-size: 2rem;
            }

            .notifications-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }

            .notification-item {
                flex-direction: column;
                align-items: stretch;
            }

            .notification-meta {
                flex-direction: column;
                align-items: flex-start;
            }

            .back-to-dashboard {
                position: static;
                margin-bottom: 20px;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="notifications-page">
        <div class="notifications-container">
            <!-- Header -->
            <div class="notifications-header">
                <a href="dashboard.html" class="back-to-dashboard">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </a>
                <h1><i class="fas fa-bell"></i> Notifications</h1>
                <p>Stay updated with your document recovery journey</p>
            </div>

            <!-- Controls -->
            <div class="notifications-controls">
                <div class="notification-filters">
                    <button class="filter-btn active" data-filter="all">
                        <i class="fas fa-inbox"></i> All
                    </button>
                    <button class="filter-btn" data-filter="info">
                        <i class="fas fa-info-circle"></i> Info
                    </button>
                    <button class="filter-btn" data-filter="success">
                        <i class="fas fa-check-circle"></i> Success
                    </button>
                    <button class="filter-btn" data-filter="warning">
                        <i class="fas fa-exclamation-triangle"></i> Warning
                    </button>
                    <button class="filter-btn" data-filter="error">
                        <i class="fas fa-times-circle"></i> Error
                    </button>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search notifications...">
                    <i class="fas fa-search"></i>
                </div>

                <div class="bulk-actions">
                    <span class="notification-count-badge" id="notificationCount">0 notifications</span>
                    <button class="mark-all-read" id="markAllRead">
                        <i class="fas fa-check-double"></i> Mark All Read
                    </button>
                    <button class="delete-selected" id="deleteSelected" disabled>
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                </div>
            </div>

            <!-- Notifications List -->
            <div class="notifications-list" id="notificationsList">
                <div class="loading-state">
                    <i class="fas fa-spinner"></i>
                    <h3>Loading notifications...</h3>
                    <p>Please wait while we fetch your notifications</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="./js/supabase.js"></script>
    <script type="module" src="./js/notification-manager.js"></script>
    <script type="module" src="./js/notifications-unified.js"></script>
    <script type="module">
        import { supabase } from './js/supabase.js';
        import { UnifiedNotificationSystem } from './js/notifications-unified.js';

        class NotificationsPage {
            constructor() {
                this.notifications = [];
                this.filteredNotifications = [];
                this.currentFilter = 'all';
                this.searchQuery = '';
                this.selectedNotifications = new Set();
                
                this.init();
            }

            async init() {
                console.log('ðŸ”” Initializing notifications page...');
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load notifications
                await this.loadNotifications();
                
                console.log('âœ… Notifications page initialized');
            }

            setupEventListeners() {
                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setFilter(e.target.dataset.filter);
                    });
                });

                // Search input
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.setSearchQuery(e.target.value);
                    });
                }

                // Bulk actions
                document.getElementById('markAllRead')?.addEventListener('click', () => {
                    this.markAllAsRead();
                });

                document.getElementById('deleteSelected')?.addEventListener('click', () => {
                    this.deleteSelected();
                });
            }

            async loadNotifications() {
                try {
                    console.log('ðŸ“¬ Loading notifications...');
                    
                    // Get current user
                    const { data: { user }, error: authError } = await supabase.auth.getUser();
                    if (authError || !user) {
                        console.error('âŒ User not authenticated:', authError);
                        this.showError('Please log in to view notifications');
                        return;
                    }

                    // Fetch notifications
                    const { data, error } = await supabase
                        .from('notifications')
                        .select('*')
                        .eq('user_id', user.id)
                        .in('status', ['unread', 'read'])
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.error('âŒ Error fetching notifications:', error);
                        this.showError('Failed to load notifications');
                        return;
                    }

                    this.notifications = data || [];
                    console.log(`âœ… Loaded ${this.notifications.length} notifications`);
                    
                    // Apply current filters
                    this.applyFilters();
                    
                } catch (error) {
                    console.error('âŒ Error loading notifications:', error);
                    this.showError('An error occurred while loading notifications');
                }
            }

            setFilter(filter) {
                this.currentFilter = filter;
                
                // Update button states
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === filter);
                });
                
                this.applyFilters();
            }

            setSearchQuery(query) {
                this.searchQuery = query.toLowerCase();
                this.applyFilters();
            }

            applyFilters() {
                let filtered = [...this.notifications];
                
                // Apply type filter
                if (this.currentFilter !== 'all') {
                    filtered = filtered.filter(n => n.type === this.currentFilter);
                }
                
                // Apply search filter
                if (this.searchQuery) {
                    filtered = filtered.filter(n => 
                        (n.message || '').toLowerCase().includes(this.searchQuery)
                    );
                }
                
                this.filteredNotifications = filtered;
                this.renderNotifications();
                this.updateCount();
            }

            renderNotifications() {
                const container = document.getElementById('notificationsList');
                
                if (this.filteredNotifications.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No notifications found</h3>
                            <p>${this.notifications.length === 0 ? 
                                'You\'re all caught up! No notifications yet.' : 
                                'No notifications match your current filters.'}
                            </p>
                        </div>
                    `;
                    return;
                }

                const html = this.filteredNotifications.map(notification => 
                    this.renderNotification(notification)
                ).join('');

                container.innerHTML = html;
                
                // Attach event listeners to rendered items
                this.attachItemListeners();
            }

            renderNotification(notification) {
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };

                const type = notification.type || 'info';
                const isUnread = notification.status === 'unread';
                const time = this.formatRelativeTime(notification.created_at || new Date().toISOString());

                return `
                    <div class="notification-item ${isUnread ? 'unread' : ''}" data-id="${notification.id}">
                        <input type="checkbox" class="notification-checkbox" data-id="${notification.id}">
                        <div class="notification-icon ${type}">
                            <i class="${icons[type] || icons.info}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-message">${this.escapeHtml(notification.message || 'No message')}</div>
                            <div class="notification-meta">
                                <span class="notification-time">${time}</span>
                                <div class="notification-actions">
                                    ${isUnread ? `<button onclick="notificationsPage.markAsRead('${notification.id}')">Mark as read</button>` : ''}
                                    <button onclick="notificationsPage.deleteNotification('${notification.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachItemListeners() {
                // Checkbox listeners
                document.querySelectorAll('.notification-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const id = e.target.dataset.id;
                        if (e.target.checked) {
                            this.selectedNotifications.add(id);
                        } else {
                            this.selectedNotifications.delete(id);
                        }
                        this.updateBulkActions();
                    });
                });

                // Click on notification item (not checkbox)
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox' && !e.target.closest('button')) {
                            const id = item.dataset.id;
                            this.viewNotification(id);
                        }
                    });
                });
            }

            updateCount() {
                const countElement = document.getElementById('notificationCount');
                const unreadCount = this.notifications.filter(n => n.status === 'unread').length;
                countElement.textContent = `${unreadCount} unread`;
            }

            updateBulkActions() {
                const deleteBtn = document.getElementById('deleteSelected');
                deleteBtn.disabled = this.selectedNotifications.size === 0;
            }

            async markAsRead(id) {
                try {
                    const { error } = await supabase
                        .from('notifications')
                        .update({ status: 'read', read_at: new Date().toISOString() })
                        .eq('id', id);

                    if (error) throw error;

                    // Update local data
                    const notification = this.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.status = 'read';
                        notification.read_at = new Date().toISOString();
                    }

                    this.applyFilters();
                    console.log('âœ… Notification marked as read:', id);
                } catch (error) {
                    console.error('âŒ Error marking notification as read:', error);
                }
            }

            async markAllAsRead() {
                try {
                    const unreadIds = this.notifications
                        .filter(n => n.status === 'unread')
                        .map(n => n.id);

                    if (unreadIds.length === 0) return;

                    const { error } = await supabase
                        .from('notifications')
                        .update({ status: 'read', read_at: new Date().toISOString() })
                        .in('id', unreadIds);

                    if (error) throw error;

                    // Update local data
                    this.notifications.forEach(n => {
                        if (n.status === 'unread') {
                            n.status = 'read';
                            n.read_at = new Date().toISOString();
                        }
                    });

                    this.applyFilters();
                    console.log('âœ… All notifications marked as read');
                } catch (error) {
                    console.error('âŒ Error marking all as read:', error);
                }
            }

            async deleteNotification(id) {
                if (!confirm('Are you sure you want to delete this notification?')) return;

                try {
                    const { error } = await supabase
                        .from('notifications')
                        .update({ status: 'deleted' })
                        .eq('id', id);

                    if (error) throw error;

                    // Update local data
                    this.notifications = this.notifications.filter(n => n.id !== id);
                    this.applyFilters();
                    console.log('âœ… Notification deleted:', id);
                } catch (error) {
                    console.error('âŒ Error deleting notification:', error);
                }
            }

            async deleteSelected() {
                if (this.selectedNotifications.size === 0) return;

                if (!confirm(`Are you sure you want to delete ${this.selectedNotifications.size} notification(s)?`)) return;

                try {
                    const { error } = await supabase
                        .from('notifications')
                        .update({ status: 'deleted' })
                        .in('id', Array.from(this.selectedNotifications));

                    if (error) throw error;

                    // Update local data
                    this.notifications = this.notifications.filter(n => !this.selectedNotifications.has(n.id));
                    this.selectedNotifications.clear();
                    this.applyFilters();
                    console.log('âœ… Selected notifications deleted');
                } catch (error) {
                    console.error('âŒ Error deleting selected notifications:', error);
                }
            }

            viewNotification(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification && notification.status === 'unread') {
                    this.markAsRead(id);
                }
                
                // Handle notification action if present
                if (notification?.notification_action && notification?.action_data) {
                    this.handleNotificationAction(notification);
                }
            }

            handleNotificationAction(notification) {
                // Handle different notification actions
                switch (notification.notification_action) {
                    case 'view_report':
                        if (notification.action_data?.report_id) {
                            window.location.href = `dashboard.html#report-${notification.action_data.report_id}`;
                        }
                        break;
                    case 'view_match':
                        if (notification.action_data?.match_id) {
                            window.location.href = `dashboard.html#match-${notification.action_data.match_id}`;
                        }
                        break;
                    default:
                        console.log('Unknown notification action:', notification.notification_action);
                }
            }

            showError(message) {
                const container = document.getElementById('notificationsList');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error</h3>
                        <p>${message}</p>
                    </div>
                `;
            }

            formatRelativeTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                
                return date.toLocaleDateString();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the notifications page
        const notificationsPage = new NotificationsPage();
        window.notificationsPage = notificationsPage;
    </script>
</body>
</html>
